<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eden Intake</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --card: #ffffff;
        --text: #0f1f33;
        --muted: #5a6b82;
        --primary: #1858a8;
        --primary-soft: #e9f1fc;
        --ok: #0d8a52;
        --warn: #a76a00;
        --bad: #b42318;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background-image: url('matisMissionPeak.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      .app {
        max-width: 480px;
        margin: 0 auto;
        min-height: 100vh;
        padding: 16px;
      }
      .top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .alert {
        background: #fff3f2;
        border: 1px solid #f4b8b2;
        border-radius: 12px;
        padding: 10px 12px;
        color: #8d1f16;
        margin-bottom: 12px;
        font-size: 14px;
      }
      .privacy-pill {
        display: inline-block;
        font-size: 12px;
        background: #edf3ff;
        color: #1b4c8f;
        border: 1px solid #c7daf8;
        border-radius: 999px;
        padding: 6px 10px;
        margin-bottom: 10px;
      }
      .lang {
        border: 1px solid #cad9ff;
        background: #fff;
        color: var(--primary);
        border-radius: 999px;
        min-height: 40px;
        padding: 0 14px;
        font-weight: 600;
      }
      .card {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      }
      .progress { color: var(--muted); font-size: 14px; margin-bottom: 8px; }
      h1 { margin: 0 0 8px; font-size: 26px; line-height: 1.2; }
      h2 { margin: 0 0 12px; font-size: 20px; }
      p { margin: 0 0 12px; color: var(--muted); }
      .chips {
        display: grid;
        gap: 10px;
      }
      .chip {
        border: 1px solid #cfdcff;
        background: #fff;
        min-height: 48px;
        border-radius: 12px;
        padding: 10px 12px;
        text-align: left;
        font-size: 16px;
      }
      .chip.active {
        background: var(--primary-soft);
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 600;
      }
      label { display: block; margin: 12px 0 6px; font-weight: 600; }
      input, textarea, select {
        width: 100%;
        border: 1px solid #cfd8ea;
        border-radius: 12px;
        min-height: 48px;
        padding: 10px 12px;
        font-size: 16px;
        background: #fff;
      }
      textarea { min-height: 88px; resize: vertical; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .yn {
        border: 1px solid #cfdcff;
        background: #fff;
        min-height: 48px;
        border-radius: 12px;
      }
      .yn.active { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }
      .stepper { display: flex; align-items: center; gap: 12px; }
      .stepper button {
        min-height: 48px;
        min-width: 56px;
        border: 1px solid #cfdcff;
        background: #fff;
        border-radius: 12px;
        font-size: 20px;
      }
      .actions { margin-top: 16px; display: flex; gap: 10px; }
      .btn {
        border: none;
        border-radius: 12px;
        min-height: 52px;
        padding: 0 16px;
        font-size: 16px;
        font-weight: 700;
      }
      .btn.secondary { background: #eef2f8; color: #334155; }
      .btn.primary { background: var(--primary); color: #fff; flex: 1; }
      .status {
        text-align: center;
        padding-top: 20px;
      }
      .pulse {
        width: 84px;
        height: 84px;
        margin: 0 auto 14px;
        border-radius: 50%;
        background: var(--primary-soft);
        border: 2px solid var(--primary);
        animation: pulse 1.6s infinite ease-in-out;
      }
      @keyframes pulse {
        0% { transform: scale(0.95); opacity: 0.8; }
        70% { transform: scale(1.06); opacity: 1; }
        100% { transform: scale(0.95); opacity: 0.8; }
      }
      .log {
        margin-top: 14px;
        text-align: left;
        max-height: 240px;
        overflow: auto;
        background: #f8faff;
        border: 1px solid #e0e8f8;
        border-radius: 12px;
        padding: 10px;
      }
      .log-item { padding: 8px; border-bottom: 1px solid #ebf1ff; font-size: 14px; }
      .tag { font-weight: 700; }
      .tag.calling { color: var(--warn); }
      .tag.failed { color: var(--bad); }
      .tag.done { color: var(--ok); }
      .result-box {
        margin-top: 16px;
        text-align: left;
        background: #effbf4;
        border: 1px solid #b9e8cb;
        border-radius: 12px;
        padding: 12px;
      }
      .hide { display: none; }
      .small { font-size: 13px; color: var(--muted); }
      .hint {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .feedback {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="top">
        <strong>Eden</strong>
        <button id="langBtn" class="lang">ES</button>
      </div>
      <div class="alert" id="safetyAlert">If you are in immediate danger, call 911 now.</div>
      <div class="card" id="wizard">
        <div class="progress" id="progress">Step 1 of 3</div>
        <div id="step1">
          <div class="privacy-pill" id="privacyPill">No name required. No account created.</div>
          <h1 id="heroTitle">You deserve to be safe tonight.</h1>
          <h2 id="s1title">What do you need?</h2>
          <div class="chips" id="needChips"></div>
        </div>
        <div id="step2" class="hide">
          <h2 id="s2title">About your situation</h2>
          <label id="peopleLabel">How many people need help?</label>
          <div class="stepper">
            <button id="minus">-</button>
            <div id="peopleCount">1</div>
            <button id="plus">+</button>
          </div>
          <label id="childrenLabel">Do you have children with you?</label>
          <div class="row">
            <button class="yn" data-field="children" data-val="true" id="childrenYes">Yes</button>
            <button class="yn" data-field="children" data-val="false" id="childrenNo">No</button>
          </div>
          <label id="petsLabel">Do you have pets?</label>
          <div class="row">
            <button class="yn" data-field="pets" data-val="true" id="petsYes">Yes</button>
            <button class="yn" data-field="pets" data-val="false" id="petsNo">No</button>
          </div>
          <label id="languagePrefLabel">Preferred spoken language</label>
          <select id="preferredLanguage">
            <option value="English">English</option>
            <option value="Spanish">Spanish</option>
            <option value="Mandarin">Mandarin</option>
            <option value="Cantonese">Cantonese</option>
            <option value="Vietnamese">Vietnamese</option>
            <option value="Tagalog">Tagalog</option>
            <option value="Hindi">Hindi</option>
            <option value="Other">Other</option>
          </select>
          <label id="urgencyLabel">How urgently do you need shelter?</label>
          <select id="urgency">
            <option value="tonight">Tonight</option>
            <option value="within_24h">Within 24 hours</option>
            <option value="within_72h">Within 72 hours</option>
          </select>
          <label id="locLabel">What city or neighborhood are you in?</label>
          <input id="location" placeholder="e.g. Mission District, SF" />
          <label id="notesLabel">Anything urgent we should know? (optional)</label>
          <textarea id="notes" maxlength="200" placeholder="e.g. I need wheelchair access"></textarea>
        </div>
        <div id="step3" class="hide">
          <h2 id="s3title">Confirm and start search</h2>
          <p class="small" id="startNote">Eden will start calling nearby shelters immediately and show live status updates here.</p>
          <p class="hint" id="resultNote">Results appear on this page when calls complete.</p>
        </div>
        <div class="actions">
          <button id="backBtn" class="btn secondary hide">Back</button>
          <button id="nextBtn" class="btn primary">Next</button>
        </div>
        <div id="actionFeedback" class="feedback" aria-live="polite"></div>
      </div>

      <div id="statusView" class="card status hide">
        <div class="pulse"></div>
        <h2 id="statusTitle">Your agent is calling shelters now...</h2>
        <p id="statusSub">Please stay on this screen while we check availability.</p>
        <div class="log" id="log"></div>
        <div id="result" class="result-box hide"></div>
      </div>
    </div>

    <script>
      const API = "http://localhost:3000";
      let step = 1;
      let pollTimer = null;
      let jobId = null;
      let lang = "en";

      const state = {
        needs: ["dv_specific", "shelter"],
        people_count: 1,
        has_children: false,
        has_pets: false,
        preferred_language: "English",
        urgency: "tonight",
        location: "",
        notes: "",
      };

      const labels = {
        en: {
          langShort: "EN",
          nextLangShort: "ES",
          step: (n) => `Step ${n} of 3`,
          next: "Next",
          back: "Back",
          submit: "Find Help Now →",
          s1title: "What do you need?",
          s2title: "About your situation",
          s3title: "Confirm and start search",
          peopleLabel: "How many people need help?",
          childrenLabel: "Do you have children with you?",
          petsLabel: "Do you have pets?",
          languagePrefLabel: "Preferred spoken language",
          urgencyLabel: "How urgently do you need shelter?",
          locLabel: "What city or neighborhood are you in?",
          notesLabel: "Anything urgent we should know? (optional)",
          startNote: "Eden will start calling nearby shelters immediately and show live status updates here.",
          resultNote: "Results appear on this page when calls complete.",
          statusTitle: "Eden is contacting shelters now...",
          statusSub: "Please stay on this screen while we check availability.",
          noBeds: (n) => `We tried ${n} shelters. No beds tonight. Call 211 for free 24/7 help.`,
          found: "They're expecting you. Please call the shelter now.",
          starting: "Starting search...",
          startingTitle: "Starting shelter search...",
          startingSub: "Connecting to Eden and preparing call attempts.",
          startFailed: "Could not start search. Check your connection and try again.",
          safetyAlert: "If you are in immediate danger, call 911 now.",
          heroTitle: "You deserve to be safe tonight.",
          privacyPill: "No name required. No account created.",
          yes: "Yes",
          no: "No",
          chips: [
            ["dv_specific", "Fleeing abuse or violence"],
            ["immigrant", "Immigrant support - no status required"],
            ["shelter", "Immediate shelter tonight"],
            ["medical", "Medical support"],
            ["mental_health", "Mental health support"],
            ["children_support", "Family and children support"],
            ["other", "Other urgent support"],
          ],
        },
        es: {
          langShort: "ES",
          nextLangShort: "EN",
          step: (n) => `Paso ${n} de 3`,
          next: "Siguiente",
          back: "Atrás",
          submit: "Buscar ayuda ahora →",
          s1title: "¿Qué necesitas?",
          s2title: "Sobre tu situación",
          s3title: "Confirma e inicia la búsqueda",
          peopleLabel: "¿Cuántas personas necesitan ayuda?",
          childrenLabel: "¿Tienes niños contigo?",
          petsLabel: "¿Tienes mascotas?",
          languagePrefLabel: "Idioma preferido para hablar",
          urgencyLabel: "¿Qué tan urgente necesitas refugio?",
          locLabel: "¿En qué ciudad o vecindario estás?",
          notesLabel: "¿Algo urgente que debamos saber? (opcional)",
          startNote: "Eden empezará a llamar a refugios cercanos de inmediato y mostrará actualizaciones aquí.",
          resultNote: "Los resultados aparecerán en esta página cuando terminen las llamadas.",
          statusTitle: "Eden está contactando refugios ahora...",
          statusSub: "Quédate en esta pantalla mientras verificamos disponibilidad.",
          noBeds: (n) => `Intentamos ${n} refugios. No hay camas esta noche. Llama al 211.`,
          found: "Te están esperando. Llama al refugio ahora.",
          starting: "Iniciando búsqueda...",
          startingTitle: "Iniciando búsqueda de refugio...",
          startingSub: "Conectando con Eden y preparando intentos de llamada.",
          startFailed: "No se pudo iniciar la búsqueda. Verifica tu conexión e inténtalo de nuevo.",
          safetyAlert: "Si estás en peligro inmediato, llama al 911 ahora.",
          heroTitle: "Mereces estar a salvo esta noche.",
          privacyPill: "No se requiere nombre. No se crea cuenta.",
          yes: "Sí",
          no: "No",
          chips: [
            ["dv_specific", "Huyendo de abuso o violencia"],
            ["immigrant", "Apoyo para inmigrantes - sin estatus requerido"],
            ["shelter", "Refugio inmediato esta noche"],
            ["medical", "Apoyo médico"],
            ["mental_health", "Apoyo de salud mental"],
            ["children_support", "Apoyo para familias con niños"],
            ["other", "Otro apoyo urgente"],
          ],
        },
      };

      const needChips = document.getElementById("needChips");
      function renderChips() {
        needChips.innerHTML = "";
        labels[lang].chips.forEach(([key, text]) => {
          const btn = document.createElement("button");
          btn.className = "chip" + (state.needs.includes(key) ? " active" : "");
          btn.textContent = text;
          btn.onclick = () => {
            if (state.needs.includes(key)) state.needs = state.needs.filter((n) => n !== key);
            else state.needs.push(key);
            renderChips();
          };
          needChips.appendChild(btn);
        });
      }

      function syncLabels() {
        document.getElementById("progress").textContent = labels[lang].step(step);
        document.getElementById("s1title").textContent = labels[lang].s1title;
        document.getElementById("s2title").textContent = labels[lang].s2title;
        document.getElementById("s3title").textContent = labels[lang].s3title;
        document.getElementById("peopleLabel").textContent = labels[lang].peopleLabel;
        document.getElementById("childrenLabel").textContent = labels[lang].childrenLabel;
        document.getElementById("petsLabel").textContent = labels[lang].petsLabel;
        document.getElementById("languagePrefLabel").textContent = labels[lang].languagePrefLabel;
        document.getElementById("urgencyLabel").textContent = labels[lang].urgencyLabel;
        document.getElementById("locLabel").textContent = labels[lang].locLabel;
        document.getElementById("notesLabel").textContent = labels[lang].notesLabel;
        document.getElementById("startNote").textContent = labels[lang].startNote;
        document.getElementById("resultNote").textContent = labels[lang].resultNote;
        document.getElementById("statusTitle").textContent = labels[lang].statusTitle;
        document.getElementById("statusSub").textContent = labels[lang].statusSub;
        document.getElementById("safetyAlert").textContent = labels[lang].safetyAlert;
        document.getElementById("heroTitle").textContent = labels[lang].heroTitle;
        document.getElementById("privacyPill").textContent = labels[lang].privacyPill;
        document.getElementById("nextBtn").textContent = step === 3 ? labels[lang].submit : labels[lang].next;
        document.getElementById("backBtn").textContent = labels[lang].back;
        document.getElementById("childrenYes").textContent = labels[lang].yes;
        document.getElementById("childrenNo").textContent = labels[lang].no;
        document.getElementById("petsYes").textContent = labels[lang].yes;
        document.getElementById("petsNo").textContent = labels[lang].no;
        document.getElementById("actionFeedback").textContent = "";
        renderChips();
      }

      function setSubmitting(isSubmitting) {
        document.getElementById("nextBtn").disabled = isSubmitting;
        document.getElementById("backBtn").disabled = isSubmitting;
        document.getElementById("langBtn").disabled = isSubmitting;
        if (isSubmitting) {
          document.getElementById("nextBtn").textContent = labels[lang].starting;
          document.getElementById("actionFeedback").textContent = labels[lang].startingSub;
        } else {
          document.getElementById("nextBtn").textContent = step === 3 ? labels[lang].submit : labels[lang].next;
        }
      }

      function setStep(n) {
        step = n;
        document.getElementById("step1").classList.toggle("hide", step !== 1);
        document.getElementById("step2").classList.toggle("hide", step !== 2);
        document.getElementById("step3").classList.toggle("hide", step !== 3);
        document.getElementById("backBtn").classList.toggle("hide", step === 1);
        syncLabels();
      }

      document.getElementById("langBtn").onclick = () => {
        const order = ["en", "es"];
        const idx = order.indexOf(lang);
        lang = order[(idx + 1) % order.length];
        document.getElementById("langBtn").textContent = labels[lang].nextLangShort;
        syncLabels();
      };

      document.getElementById("minus").onclick = () => {
        state.people_count = Math.max(1, state.people_count - 1);
        document.getElementById("peopleCount").textContent = String(state.people_count);
      };
      document.getElementById("plus").onclick = () => {
        state.people_count = Math.min(5, state.people_count + 1);
        document.getElementById("peopleCount").textContent = state.people_count === 5 ? "5+" : String(state.people_count);
      };

      document.querySelectorAll(".yn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const field = btn.dataset.field;
          const val = btn.dataset.val === "true";
          if (field === "children") {
            state.has_children = val;
            document.getElementById("childrenYes").classList.toggle("active", val);
            document.getElementById("childrenNo").classList.toggle("active", !val);
          }
          if (field === "pets") {
            state.has_pets = val;
            document.getElementById("petsYes").classList.toggle("active", val);
            document.getElementById("petsNo").classList.toggle("active", !val);
          }
        });
      });

      document.getElementById("backBtn").onclick = () => setStep(Math.max(1, step - 1));
      document.getElementById("nextBtn").onclick = async () => {
        if (step < 3) return setStep(step + 1);
        state.preferred_language = document.getElementById("preferredLanguage").value;
        state.urgency = document.getElementById("urgency").value;
        state.location = document.getElementById("location").value.trim();
        const userNotes = document.getElementById("notes").value.trim();
        state.notes = [
          userNotes,
          `preferred_language=${state.preferred_language}`,
          `urgency=${state.urgency}`,
        ]
          .filter(Boolean)
          .join(" | ");
        if (!state.location || state.needs.length === 0) {
          alert("Please select needs and enter location.");
          return;
        }
        await submitIntake();
      };

      async function submitIntake() {
        setSubmitting(true);
        document.getElementById("statusView").classList.remove("hide");
        document.getElementById("statusTitle").textContent = labels[lang].startingTitle;
        document.getElementById("statusSub").textContent = labels[lang].startingSub;
        document.getElementById("log").innerHTML = `<div class="log-item">Eden received your request.</div>`;
        document.getElementById("wizard").classList.add("hide");
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort("request_timeout"), 15000);
          const res = await fetch(`${API}/api/intake`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(state),
            signal: controller.signal,
          });
          clearTimeout(timeoutId);
          const text = await res.text();
          let data = {};
          try {
            data = text ? JSON.parse(text) : {};
          } catch {
            data = { error: text || "Failed to start intake." };
          }
          if (!res.ok) {
            throw new Error(data.error || "Failed to start intake.");
          }
          jobId = data.job_id;
          document.getElementById("statusTitle").textContent = labels[lang].statusTitle;
          document.getElementById("statusSub").textContent = labels[lang].statusSub;
          pollTimer = setInterval(loadStatus, 3000);
          loadStatus();
        } catch (error) {
          document.getElementById("statusView").classList.add("hide");
          document.getElementById("wizard").classList.remove("hide");
          document.getElementById("actionFeedback").textContent = labels[lang].startFailed;
          const message =
            error && typeof error === "object" && "name" in error && error.name === "AbortError"
              ? "Request timed out. Please confirm the API is running and try again."
              : error instanceof Error
                ? error.message
                : labels[lang].startFailed;
          alert(message);
        } finally {
          setSubmitting(false);
        }
      }

      async function loadStatus() {
        if (!jobId) return;
        const res = await fetch(`${API}/api/intake/status/${jobId}`);
        const data = await res.json();
        if (!res.ok) return;
        const log = document.getElementById("log");
        log.innerHTML = "";
        data.attempts.forEach((a) => {
          const row = document.createElement("div");
          row.className = "log-item";
          const cls = a.status === "calling" ? "calling" : a.status === "failed" ? "failed" : a.status === "completed" ? "done" : "";
          row.innerHTML = `<strong>${a.shelter_name}</strong><br><span class="tag ${cls}">${a.status}</span>${a.reason ? ` - ${a.reason}` : ""}`;
          log.appendChild(row);
        });

        if (data.result) {
          clearInterval(pollTimer);
          const box = document.getElementById("result");
          box.classList.remove("hide");
          box.innerHTML = `
            <h3 style="margin:0 0 8px;color:#1f9d5b;">Help Found</h3>
            <p><strong>${data.result.shelter_name}</strong><br>${data.result.address || ""} ${data.result.city || ""}<br>${data.result.intake_phone || ""}</p>
            <p>${labels[lang].found}</p>
          `;
        } else if (data.status === "failed") {
          clearInterval(pollTimer);
          const box = document.getElementById("result");
          box.classList.remove("hide");
          box.innerHTML = `<h3 style="margin:0 0 8px;color:#d97706;">No Immediate Bed</h3><p>${labels[lang].noBeds(data.attempts.length)}</p>`;
        }
      }

      setStep(1);
      syncLabels();
      renderChips();
      document.getElementById("langBtn").textContent = labels[lang].nextLangShort;
    </script>
  </body>
</html>
