<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eden Intake</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Charm:wght@400&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg: #f5f7fb;
        --card: #ffffff;
        --text: #0f1f33;
        --muted: #5a6b82;
        --primary: #1858a8;
        --primary-soft: #e9f1fc;
        --ok: #0d8a52;
        --warn: #a76a00;
        --bad: #b42318;
      }
      * { box-sizing: border-box; font-family: 'Inter', sans-serif; letter-spacing: 0.04em; font-weight: 300; }
      html {
        scroll-behavior: smooth;
        min-height: 100%;
        background-color: #5a6b4e;
      }
      html::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image: url('matisMissionPeak.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        z-index: -2;
      }
      html::after {
        content: '';
        position: fixed;
        inset: 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0.18) 100%);
        z-index: -1;
        pointer-events: none;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: transparent;
        color: var(--text);
        font-family: 'Inter', sans-serif;
      }
      .app {
        max-width: 520px;
        margin: 0 auto;
        min-height: 100vh;
        padding: 20px 24px;
      }
      @media (min-width: 900px) {
        .app {
          max-width: 900px;
          padding: 24px 32px;
        }
        .chips {
          grid-template-columns: repeat(2, 1fr);
        }
        .step-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px 28px;
          align-items: start;
        }
        #step2 .step-grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 12px 20px;
        }
        #step2 .step-grid .span-full { grid-column: 1 / -1; }
        #step2 .yn-row { grid-template-columns: repeat(3, 1fr); grid-column: 1 / -1; }
        #step2 .yn-group { min-width: 0; }
        #step2 .yn-group .row { display: flex; gap: 8px; margin-top: 6px; }
        #step2 .yn-group .yn { flex: 1; min-height: 42px; }
        .step-grid .span-full { grid-column: 1 / -1; }
        .step-grid .row { grid-column: 1 / -1; }
        .step-grid .field-group { margin-top: 0; }
        .card.status .status-body {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 24px;
          align-items: start;
        }
        .card.status .status-body:has(#result.hide) .log-section { grid-column: 1 / -1; }
        .card.status .log { max-height: 280px; }
        .card.status .result-box { margin-top: 0; }
        .step1-top {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 32px;
          align-items: start;
        }
        .step1-hero { padding-right: 8px; }
        .step1-chips {
          padding-left: 24px;
          border-left: 1px solid rgba(255, 255, 255, 0.4);
        }
        .step1-chips .chips { margin-top: 8px; }
      }
      @media (min-width: 1200px) {
        .app { max-width: 960px; }
      }
      .top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .brand-logo {
        height: 52px;
        width: 52px;
        object-fit: contain;
      }
      .brand-name {
        font-family: 'Charm', cursive;
        font-weight: 400;
        font-size: 38px;
        letter-spacing: 0.2em;
        color: #e8c9d4;
      }
      .alert {
        background: rgba(255, 255, 255, 0.45);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 14px;
        padding: 12px 16px;
        color: #a62d22;
        margin-bottom: 16px;
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 0.02em;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }
      .privacy-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        letter-spacing: 0.06em;
        font-weight: 500;
        color: #1a2d3d;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.65);
        border-radius: 999px;
        padding: 7px 14px;
        margin-bottom: 12px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      }
      .privacy-pill::before {
        content: '✓';
        font-size: 12px;
        font-weight: 700;
        color: var(--ok);
      }
      .step1-hero h1 { margin-bottom: 12px; }
      .step1-hero h2 { margin: 20px 0 12px; font-size: 16px; font-weight: 600; }
      .step1-hero label { margin-top: 0; }
      .step1-hero .row { margin-top: 10px; }
      .step1-chips label { margin-bottom: 10px; display: block; }
      .step1-safe-block {
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 14px;
        padding: 18px;
        margin-top: 12px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }
      .step1-safe-block .callout { margin-top: 14px; margin-bottom: 0; }
      .lang {
        border: none;
        background: linear-gradient(rgba(0,0,0,0.15), rgba(0,0,0,0.15)), url('matisMissionPeak.jpg') center / cover fixed;
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent !important;
        border-radius: 999px;
        min-height: 40px;
        padding: 0 16px;
        font-weight: 500;
        font-size: 13px;
        letter-spacing: 0.06em;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .lang:hover {
        transform: translateY(-1px);
      }
      .lang::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 999px;
        z-index: -1;
      }
      .card {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.52) 0%, rgba(255, 255, 255, 0.38) 100%);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid rgba(255, 255, 255, 0.65);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06), 0 8px 32px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
      .progress-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
      }
      .progress-dot {
        flex: 1;
        height: 5px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.4);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .progress-dot.filled {
        background: linear-gradient(90deg, rgba(24, 88, 168, 0.7), rgba(24, 88, 168, 0.85));
        box-shadow: 0 0 8px rgba(24, 88, 168, 0.35);
      }
      .progress { font-size: 12px; color: var(--muted); margin-bottom: 20px; letter-spacing: 0.08em; text-transform: uppercase; }
      h1 { margin: 0 0 16px; font-size: 32px; line-height: 1.2; letter-spacing: 0.02em; font-weight: 600; }
      h2 { margin: 0 0 16px; font-size: 18px; font-weight: 600; letter-spacing: 0.03em; }
      p { margin: 0 0 14px; line-height: 1.5; }
      h1, h2, p, label, .progress, .small, .hint, strong {
        background:
          linear-gradient(rgba(0, 0, 0, 0.38), rgba(0, 0, 0, 0.55)),
          url('matisMissionPeak.jpg') center / cover fixed;
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
      }
      #safetyModal h2, #safetyModal p, #safetyModal strong, #safetyModal button {
        background: none !important;
        -webkit-background-clip: unset !important;
        background-clip: unset !important;
        color: #3a3a3a !important;
      }
      .result-box h3, .result-box p, .result-box strong {
        background: none !important;
        -webkit-background-clip: unset !important;
        background-clip: unset !important;
        color: #1a2d3d !important;
      }
      .chip, .yn, .lang, .btn {
        color: #3d5230 !important;
      }
      .chips {
        display: grid;
        gap: 10px;
      }
      @media (min-width: 480px) {
        #step1 .chips { grid-template-columns: repeat(2, 1fr); }
      }
      @media (min-width: 600px) {
        #step2 .step-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 14px 20px;
        }
        #step2 .step-grid .span-full { grid-column: 1 / -1; }
        #step2 .yn-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
          grid-column: 1 / -1;
        }
        #step2 .yn-group { min-width: 0; }
        #step2 .yn-group .row { display: flex; gap: 8px; margin-top: 6px; }
        #step2 .yn-group .yn { flex: 1; min-height: 42px; }
      }
      .chip {
        border: 1px solid rgba(255, 255, 255, 0.58);
        background: rgba(255, 255, 255, 0.42);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        min-height: 48px;
        border-radius: 14px;
        padding: 12px 14px;
        text-align: left;
        font-size: 15px;
        font-weight: 400;
        color: inherit;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.5);
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
        cursor: pointer;
      }
      .chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.07), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
      .chip:focus-visible {
        outline: 2px solid rgba(24, 88, 168, 0.5);
        outline-offset: 2px;
      }
      .chip.active {
        background: var(--primary-soft);
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 300;
      }
      label { display: block; margin: 16px 0 8px; font-weight: 400; font-size: 15px; }
      label.required::after {
        content: ' *';
        color: var(--primary);
        font-weight: 600;
      }
      input.invalid, select.invalid, .field-group.invalid input, .field-group.invalid select {
        border-color: rgba(180, 35, 24, 0.5);
        box-shadow: 0 0 0 2px rgba(180, 35, 24, 0.15);
      }
      .validation-msg {
        font-size: 13px;
        color: var(--bad);
        margin-top: 6px;
      }
      .step1-chips.invalid .chips {
        box-shadow: 0 0 0 2px rgba(180, 35, 24, 0.35);
        border-radius: 14px;
      }
      input, textarea, select {
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 14px;
        min-height: 48px;
        padding: 12px 14px;
        font-size: 15px;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.5);
        color: #1a2d3d;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: rgba(24, 88, 168, 0.5);
        box-shadow: 0 0 0 3px rgba(24, 88, 168, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
      input::placeholder, textarea::placeholder { color: rgba(26, 45, 61, 0.7); }
      select option { background: rgba(255,255,255,0.95); color: #1a2d3d; }
      textarea { min-height: 88px; resize: vertical; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .yn {
        border: 1px solid rgba(255, 255, 255, 0.58);
        background: rgba(255, 255, 255, 0.42);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        min-height: 48px;
        border-radius: 14px;
        font-weight: 400;
        color: inherit;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.5);
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
        cursor: pointer;
      }
      .yn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.07), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
      .yn:focus-visible {
        outline: 2px solid rgba(24, 88, 168, 0.5);
        outline-offset: 2px;
      }
      .yn.active { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }
      .stepper { display: flex; align-items: center; gap: 14px; }
      .stepper button {
        min-height: 48px;
        min-width: 56px;
        border: 1px solid rgba(255, 255, 255, 0.58);
        background: rgba(255, 255, 255, 0.42);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 14px;
        font-size: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.5);
        color: inherit;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        cursor: pointer;
      }
      .stepper button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.07), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
      .stepper #peopleCount {
        min-width: 48px;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
      }
      .actions { margin-top: 24px; display: flex; gap: 12px; }
      .btn {
        border: none;
        border-radius: 14px;
        min-height: 54px;
        padding: 0 20px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .btn.secondary {
        background: rgba(255, 255, 255, 0.42);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.5);
        color: inherit;
      }
      .btn.secondary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.07), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
      .btn.secondary:focus-visible {
        outline: 2px solid rgba(24, 88, 168, 0.5);
        outline-offset: 2px;
      }
      .btn.primary {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.55) 0%, rgba(255, 255, 255, 0.42) 100%);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.7);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06), 0 4px 20px rgba(24, 88, 168, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.6);
        flex: 1;
      }
      .btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 8px 28px rgba(24, 88, 168, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.6);
      }
      .btn.primary:focus-visible {
        outline: 2px solid rgba(24, 88, 168, 0.5);
        outline-offset: 2px;
      }
      .btn:active {
        transform: translateY(0);
      }
      .chip:active, .yn:active {
        transform: translateY(0);
      }
      .status {
        text-align: center;
        padding-top: 8px;
      }
      .status-header {
        margin-bottom: 24px;
      }
      .status-header h2 { margin: 0 0 6px; font-size: 20px; font-weight: 600; }
      .status-header p { margin: 0; font-size: 14px; color: var(--muted); }
      .pulse {
        width: 72px;
        height: 72px;
        margin: 0 auto 16px;
        border-radius: 50%;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0.45) 100%);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid rgba(255, 255, 255, 0.7);
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08), 0 0 0 2px rgba(24, 88, 168, 0.3);
        animation: pulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .pulse-icon {
        width: 28px;
        height: 28px;
        color: var(--primary);
        opacity: 0.9;
        animation: pulse-icon 2s ease-in-out infinite;
      }
      @keyframes pulse {
        0%, 100% { transform: scale(0.98); opacity: 0.92; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08), 0 0 0 2px rgba(24, 88, 168, 0.3); }
        50% { transform: scale(1.03); opacity: 1; box-shadow: 0 6px 28px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(24, 88, 168, 0.4); }
      }
      @keyframes pulse-icon {
        0%, 100% { opacity: 0.75; transform: scale(0.95); }
        50% { opacity: 1; transform: scale(1.05); }
      }
      .status-body { margin-top: 20px; }
      .log-label {
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 12px;
      }
      .log {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 280px;
        overflow: auto;
      }
      .log-item {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px 12px;
        align-items: center;
        padding: 14px 16px;
        background: rgba(255, 255, 255, 0.45);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 14px;
        font-size: 15px;
        line-height: 1.4;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        transition: box-shadow 0.15s ease;
      }
      .log-item.calling { border-color: rgba(24, 88, 168, 0.4); box-shadow: 0 2px 12px rgba(24, 88, 168, 0.1); }
      .log-item-name { font-weight: 600; min-width: 0; }
      .log-item-tag {
        flex-shrink: 0;
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        padding: 5px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      .log-item-tag.calling {
        background: rgba(167, 106, 0, 0.2);
        border-color: rgba(167, 106, 0, 0.4);
        color: var(--warn);
      }
      .log-item-tag.failed {
        background: rgba(180, 35, 24, 0.12);
        border-color: rgba(180, 35, 24, 0.35);
        color: var(--bad);
      }
      .log-item-tag.done {
        background: rgba(13, 138, 82, 0.2);
        border-color: rgba(13, 138, 82, 0.4);
        color: var(--ok);
      }
      .log-item-reason {
        grid-column: 1 / -1;
        font-size: 12px;
        color: var(--muted);
        padding-top: 4px;
        border-top: 1px solid rgba(255, 255, 255, 0.3);
      }
      .result-box {
        margin-top: 0;
        text-align: left;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.55) 0%, rgba(255, 255, 255, 0.42) 100%);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid rgba(255, 255, 255, 0.65);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }
      .result-box h3 { margin: 0 0 12px; font-size: 18px; font-weight: 600; }
      .result-box.success h3 { color: var(--ok); }
      .result-box.warn h3 { color: var(--warn); }
      .hide { display: none; }
      .small { font-size: 13px; color: var(--muted); }
      .hint {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .feedback {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
      }
      #actionFeedback.validation-error {
        color: var(--bad);
        font-weight: 500;
      }
      .callout {
        margin-top: 12px;
        border-radius: 14px;
        padding: 12px 14px;
        font-size: 13px;
        line-height: 1.45;
        border: 1px solid rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.42);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }
      .callout.warn {
        border-color: rgba(200, 80, 80, 0.4);
        background: rgba(255, 255, 255, 0.2);
      }
      .field-group {
        margin-top: 12px;
      }
      .modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 999;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .modal-glass {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.25) 100%);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 20px;
        padding: 28px 24px;
        max-width: 400px;
        width: 100%;
        position: relative;
        box-shadow: 0 8px 48px rgba(0, 0, 0, 0.15);
      }
      .modal-close {
        position: absolute;
        top: 14px;
        right: 16px;
        background: none;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: #3a3a3a;
        line-height: 1;
        opacity: 0.8;
        transition: opacity 0.2s ease;
      }
      .modal-close:hover {
        opacity: 1;
      }
      .modal-btn {
        margin-top: 24px;
        width: 100%;
        background: rgba(255, 255, 255, 0.35);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 14px;
        padding: 14px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        color: #3a3a3a;
        font-family: 'Inter', sans-serif;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .modal-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      }
    </style>
  </head>
  <body>
    <div id="safetyModal" class="modal-overlay">
      <div class="modal-glass">
        <button onclick="document.getElementById('safetyModal').remove()" class="modal-close">×</button>
        <h2 style="margin: 0 0 14px; font-size: 20px; color: #3a3a3a;">Leave this site safely</h2>
        <p style="margin: 0 0 12px; font-size: 15px; color: #3a3a3a; line-height: 1.5;">You can quickly leave this website by clicking the <strong>×</strong> in the top right or by pressing the <strong>Escape key twice</strong>.</p>
        <p style="margin: 0; font-size: 15px; color: #3a3a3a; line-height: 1.5;">To browse this site safely, be sure to regularly <strong>clear your browser history</strong>.</p>
        <button onclick="document.getElementById('safetyModal').remove()" class="modal-btn">I understand</button>
      </div>
    </div>
    <div class="app">
      <div class="top">
        <div class="brand">
          <img src="EdenLogo.png" alt="Eden" class="brand-logo" />
          <span class="brand-name">Eden</span>
        </div>
        <button id="langBtn" class="lang">ES</button>
      </div>
      <div class="alert" id="safetyAlert">If you are in immediate danger, call 911 now.</div>
      <div class="card" id="wizard">
        <div class="progress-bar" id="progressBar" aria-hidden="true">
          <div class="progress-dot filled" data-step="1"></div>
          <div class="progress-dot" data-step="2"></div>
          <div class="progress-dot" data-step="3"></div>
          <div class="progress-dot" data-step="4"></div>
        </div>
        <div class="progress" id="progress">Step 1 of 4</div>
        <div id="step1">
          <div class="step1-top">
            <div class="step1-hero">
              <div class="privacy-pill" id="privacyPill">No name required. No account created.</div>
              <h1 id="heroTitle">You deserve to be safe tonight.</h1>
              <h2 id="s1title">Situation right now</h2>
              <div class="step1-safe-block">
                <label id="safeNowLabel">Are you currently in a safe place?</label>
                <div class="row">
                  <button class="yn" data-field="safeNow" data-val="true" id="safeNowYes">Yes</button>
                  <button class="yn" data-field="safeNow" data-val="false" id="safeNowNo">No</button>
                </div>
                <div id="safeNowWarning" class="callout warn hide">If you are not currently safe, call 911 first before continuing.</div>
              </div>
            </div>
            <div class="step1-chips">
              <label id="needLabel" class="required">What support do you need first?</label>
              <div class="chips" id="needChips"></div>
            </div>
          </div>
        </div>
        <div id="step2" class="hide">
          <h2 id="s2title">About your group</h2>
          <div class="step-grid">
            <div class="field-group">
              <label id="peopleLabel" class="required">How many people need help?</label>
              <div class="stepper">
                <button id="minus">-</button>
                <div id="peopleCount">1</div>
                <button id="plus">+</button>
              </div>
            </div>
            <div class="field-group">
              <label id="genderLabel">Gender identity</label>
              <select id="genderIdentity">
                <option value="woman">Woman</option>
                <option value="man">Man</option>
                <option value="nonbinary">Non-binary</option>
                <option value="trans_woman">Trans woman</option>
                <option value="trans_man">Trans man</option>
                <option value="prefer_not">Prefer not to say</option>
              </select>
            </div>
            <div class="field-group">
              <label id="ageRangeLabel">Age range</label>
              <select id="ageRange">
                <option value="18_24">18-24</option>
                <option value="25_34">25-34</option>
                <option value="35_49">35-49</option>
                <option value="50_plus">50+</option>
              </select>
            </div>
            <div class="yn-row span-full">
              <div class="yn-group">
                <label id="childrenLabel">Do you have children with you?</label>
                <div class="row">
                  <button class="yn" data-field="children" data-val="true" id="childrenYes">Yes</button>
                  <button class="yn" data-field="children" data-val="false" id="childrenNo">No</button>
                </div>
              </div>
              <div class="yn-group">
                <label id="pregnantLabel">Are you currently pregnant?</label>
                <div class="row">
                  <button class="yn" data-field="pregnant" data-val="yes" id="pregnantYes">Yes</button>
                  <button class="yn" data-field="pregnant" data-val="no" id="pregnantNo">No</button>
                </div>
              </div>
              <div class="yn-group">
                <label id="petsLabel">Do you have pets?</label>
                <div class="row">
                  <button class="yn" data-field="pets" data-val="true" id="petsYes">Yes</button>
                  <button class="yn" data-field="pets" data-val="false" id="petsNo">No</button>
                </div>
              </div>
            </div>
            <div id="childAgesGroup" class="field-group span-full hide">
              <label id="childAgesLabel">Child ages (comma separated)</label>
              <input id="childAges" placeholder="e.g. 2, 5, 11" />
            </div>
            <div id="pregnancyInfo" class="callout hide span-full">Some shelters prioritize beds for pregnant clients. Eden will include that in matching.</div>
            <div class="field-group">
              <label id="sobrietyLabel">Current sobriety status</label>
              <select id="sobriety">
                <option value="unknown">Prefer not to say</option>
                <option value="clean_sober">Currently clean/sober</option>
                <option value="not_currently_sober">Not currently sober</option>
              </select>
            </div>
            <div id="sobrietyInfo" class="callout hide span-full">Eden will avoid shelters with sobriety requirements when possible.</div>
          </div>
        </div>
        <div id="step3" class="hide">
          <h2 id="s3title">Location and context</h2>
          <div class="step-grid">
            <div class="field-group">
              <label id="languagePrefLabel">Preferred spoken language</label>
              <select id="preferredLanguage">
                <option value="English">English</option>
                <option value="Spanish">Spanish</option>
                <option value="Mandarin">Mandarin</option>
                <option value="Cantonese">Cantonese</option>
                <option value="Vietnamese">Vietnamese</option>
                <option value="Tagalog">Tagalog</option>
                <option value="Hindi">Hindi</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="field-group">
              <label id="urgencyLabel" class="required">How urgently do you need shelter?</label>
              <select id="urgency">
                <option value="tonight">Tonight</option>
                <option value="within_24h">Within 24 hours</option>
                <option value="within_72h">Within 72 hours</option>
              </select>
            </div>
            <div class="field-group">
              <label id="accessibilityLabel">Accessibility needs</label>
              <select id="accessibilityNeeds">
                <option value="none">None</option>
                <option value="wheelchair">Wheelchair access</option>
                <option value="mobility">General mobility support</option>
              </select>
            </div>
            <div class="field-group">
              <label id="altContactLabel">Alternate contact (trusted person, optional)</label>
              <input id="alternateContact" placeholder="Name + phone number" />
            </div>
            <div class="field-group span-full">
              <label id="locLabel" class="required">What city or neighborhood are you in?</label>
              <input id="location" type="text" required placeholder="e.g. Mission District, SF" autocomplete="address-level2" />
            </div>
            <div class="field-group span-full">
              <label id="notesLabel">Anything urgent we should know? (optional)</label>
              <textarea id="notes" maxlength="200" placeholder="e.g. I need wheelchair access"></textarea>
            </div>
          </div>
        </div>
        <div id="step4" class="hide">
          <h2 id="s4title">Confirm and start search</h2>
          <p class="small" id="startNote">Eden will start calling nearby shelters immediately and show live status updates here.</p>
          <p class="hint" id="resultNote">Results appear on this page when calls complete.</p>
        </div>
        <div class="actions">
          <button id="backBtn" class="btn secondary hide">Back</button>
          <button id="nextBtn" class="btn primary">Next</button>
        </div>
        <div id="actionFeedback" class="feedback" aria-live="polite"></div>
      </div>

      <div id="statusView" class="card status hide">
        <div class="status-header">
          <div class="pulse">
            <svg class="pulse-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
            </svg>
          </div>
          <h2 id="statusTitle">Your agent is calling shelters now...</h2>
          <p id="statusSub">Please stay on this screen while we check availability.</p>
        </div>
        <div class="status-body">
          <div class="log-section">
            <div class="log-label" id="logLabel">Shelter calls</div>
            <div class="log" id="log"></div>
          </div>
          <div id="result" class="result-box hide"></div>
        </div>
      </div>
    </div>

    <script>
      const API = "http://localhost:3000";
      let step = 1;
      let pollTimer = null;
      let jobId = null;
      let lang = "en";

      const state = {
        currently_safe: true,
        needs: [],
        people_count: 1,
        gender_identity: "woman",
        age_range: "25_34",
        has_children: false,
        child_ages: "",
        pregnant: "no",
        sobriety: "unknown",
        has_pets: false,
        preferred_language: "English",
        urgency: "tonight",
        accessibility_needs: "none",
        alternate_contact: "",
        location: "",
        notes: "",
      };

      const labels = {
        en: {
          nextLangShort: "ES",
          step: (n) => `Step ${n} of 4`,
          next: "Next",
          back: "Back",
          submit: "Find Help Now",
          s1title: "Situation right now",
          s2title: "About your group",
          s3title: "Location and context",
          s4title: "Confirm and start search",
          safeNowLabel: "Are you currently in a safe place?",
          safeNowWarning: "If you are not currently safe, call 911 first before continuing.",
          needLabel: "What support do you need first?",
          peopleLabel: "How many people need help?",
          genderLabel: "Gender identity",
          ageRangeLabel: "Age range",
          childrenLabel: "Do you have children with you?",
          childAgesLabel: "Child ages (comma separated)",
          pregnantLabel: "Are you currently pregnant?",
          pregnancyInfo: "Some shelters prioritize beds for pregnant clients. Eden will include that in matching.",
          sobrietyLabel: "Current sobriety status",
          sobrietyInfo: "Eden will avoid shelters with sobriety requirements when possible.",
          petsLabel: "Do you have pets?",
          languagePrefLabel: "Preferred spoken language",
          urgencyLabel: "How urgently do you need shelter?",
          accessibilityLabel: "Accessibility needs",
          altContactLabel: "Alternate contact (trusted person, optional)",
          locLabel: "What city or neighborhood are you in?",
          notesLabel: "Anything urgent we should know? (optional)",
          startNote: "Eden will start calling nearby shelters immediately and show live status updates here.",
          resultNote: "Results appear on this page when calls complete.",
          statusTitle: "Eden is contacting shelters now...",
          statusSub: "Please stay on this screen while we check availability.",
          noBeds: (n) => `We tried ${n} shelters. No beds tonight. Call 211 for free 24/7 help.`,
          found: "They're expecting you. Please call the shelter now.",
          starting: "Starting search...",
          startingTitle: "Starting shelter search...",
          startingSub: "Connecting to Eden and preparing call attempts.",
          startFailed: "Could not start search. Check your connection and try again.",
          safetyAlert: "If you are in immediate danger, call 911 now.",
          heroTitle: "You deserve to be safe tonight.",
          privacyPill: "No name required. No account created.",
          yes: "Yes",
          no: "No",
          requiredNeeds: "Please select at least one type of support.",
          requiredLocation: "Please enter your city or neighborhood.",
          chips: [
            ["dv_specific", "Fleeing abuse or violence"],
            ["immigrant", "Immigrant support - no status required"],
            ["shelter", "Immediate shelter tonight"],
            ["medical", "Medical support"],
            ["mental_health", "Mental health support"],
            ["children_support", "Family and children support"],
            ["other", "Other urgent support"],
          ],
        },
        es: {
          nextLangShort: "EN",
          step: (n) => `Paso ${n} de 4`,
          next: "Siguiente",
          back: "Atrás",
          submit: "Buscar ayuda ahora",
          s1title: "Situación actual",
          s2title: "Sobre tu grupo",
          s3title: "Ubicación y contexto",
          s4title: "Confirma e inicia la búsqueda",
          safeNowLabel: "¿Estás actualmente en un lugar seguro?",
          safeNowWarning: "Si no estás en un lugar seguro, llama al 911 primero.",
          needLabel: "¿Qué apoyo necesitas primero?",
          peopleLabel: "¿Cuántas personas necesitan ayuda?",
          genderLabel: "Identidad de género",
          ageRangeLabel: "Rango de edad",
          childrenLabel: "¿Tienes niños contigo?",
          childAgesLabel: "Edades de los niños (separadas por coma)",
          pregnantLabel: "¿Estás embarazada actualmente?",
          pregnancyInfo: "Algunos refugios priorizan camas para personas embarazadas. Eden lo incluirá en el filtro.",
          sobrietyLabel: "Estado actual de sobriedad",
          sobrietyInfo: "Eden evitará refugios con requisito de sobriedad cuando sea posible.",
          petsLabel: "¿Tienes mascotas?",
          languagePrefLabel: "Idioma preferido para hablar",
          urgencyLabel: "¿Qué tan urgente necesitas refugio?",
          accessibilityLabel: "Necesidades de accesibilidad",
          altContactLabel: "Contacto alternativo (persona de confianza, opcional)",
          locLabel: "¿En qué ciudad o vecindario estás?",
          notesLabel: "¿Algo urgente que debamos saber? (opcional)",
          startNote: "Eden empezará a llamar a refugios cercanos de inmediato y mostrará actualizaciones aquí.",
          resultNote: "Los resultados aparecerán en esta página cuando terminen las llamadas.",
          statusTitle: "Eden está contactando refugios ahora...",
          statusSub: "Quédate en esta pantalla mientras verificamos disponibilidad.",
          noBeds: (n) => `Intentamos ${n} refugios. No hay camas esta noche. Llama al 211.`,
          found: "Te están esperando. Llama al refugio ahora.",
          starting: "Iniciando búsqueda...",
          startingTitle: "Iniciando búsqueda de refugio...",
          startingSub: "Conectando con Eden y preparando intentos de llamada.",
          startFailed: "No se pudo iniciar la búsqueda. Verifica tu conexión e inténtalo de nuevo.",
          safetyAlert: "Si estás en peligro inmediato, llama al 911 ahora.",
          heroTitle: "Mereces estar a salvo esta noche.",
          privacyPill: "No se requiere nombre. No se crea cuenta.",
          yes: "Sí",
          no: "No",
          requiredNeeds: "Por favor selecciona al menos un tipo de apoyo.",
          requiredLocation: "Por favor ingresa tu ciudad o vecindario.",
          chips: [
            ["dv_specific", "Huyendo de abuso o violencia"],
            ["immigrant", "Apoyo para inmigrantes - sin estatus requerido"],
            ["shelter", "Refugio inmediato esta noche"],
            ["medical", "Apoyo médico"],
            ["mental_health", "Apoyo de salud mental"],
            ["children_support", "Apoyo para familias con niños"],
            ["other", "Otro apoyo urgente"],
          ],
        },
      };

      const needChips = document.getElementById("needChips");
      function renderChips() {
        needChips.innerHTML = "";
        labels[lang].chips.forEach(([key, text]) => {
          const btn = document.createElement("button");
          btn.className = "chip" + (state.needs.includes(key) ? " active" : "");
          btn.textContent = text;
          btn.onclick = () => {
            if (state.needs.includes(key)) state.needs = state.needs.filter((n) => n !== key);
            else state.needs.push(key);
            clearValidation();
            renderChips();
          };
          needChips.appendChild(btn);
        });
      }

      function updateCallouts() {
        document.getElementById("safeNowWarning").classList.toggle("hide", state.currently_safe);
        document.getElementById("childAgesGroup").classList.toggle("hide", !state.has_children);
        document.getElementById("pregnancyInfo").classList.toggle("hide", state.pregnant !== "yes");
        document.getElementById("sobrietyInfo").classList.toggle("hide", state.sobriety !== "not_currently_sober");
      }

      function syncLabels() {
        document.getElementById("progress").textContent = labels[lang].step(step);
        document.getElementById("s1title").textContent = labels[lang].s1title;
        document.getElementById("s2title").textContent = labels[lang].s2title;
        document.getElementById("s3title").textContent = labels[lang].s3title;
        document.getElementById("s4title").textContent = labels[lang].s4title;
        document.getElementById("safeNowLabel").textContent = labels[lang].safeNowLabel;
        document.getElementById("safeNowWarning").textContent = labels[lang].safeNowWarning;
        document.getElementById("needLabel").textContent = labels[lang].needLabel;
        document.getElementById("peopleLabel").textContent = labels[lang].peopleLabel;
        document.getElementById("genderLabel").textContent = labels[lang].genderLabel;
        document.getElementById("ageRangeLabel").textContent = labels[lang].ageRangeLabel;
        document.getElementById("childrenLabel").textContent = labels[lang].childrenLabel;
        document.getElementById("childAgesLabel").textContent = labels[lang].childAgesLabel;
        document.getElementById("pregnantLabel").textContent = labels[lang].pregnantLabel;
        document.getElementById("pregnancyInfo").textContent = labels[lang].pregnancyInfo;
        document.getElementById("sobrietyLabel").textContent = labels[lang].sobrietyLabel;
        document.getElementById("sobrietyInfo").textContent = labels[lang].sobrietyInfo;
        document.getElementById("petsLabel").textContent = labels[lang].petsLabel;
        document.getElementById("languagePrefLabel").textContent = labels[lang].languagePrefLabel;
        document.getElementById("urgencyLabel").textContent = labels[lang].urgencyLabel;
        document.getElementById("accessibilityLabel").textContent = labels[lang].accessibilityLabel;
        document.getElementById("altContactLabel").textContent = labels[lang].altContactLabel;
        document.getElementById("locLabel").textContent = labels[lang].locLabel;
        document.getElementById("notesLabel").textContent = labels[lang].notesLabel;
        document.getElementById("startNote").textContent = labels[lang].startNote;
        document.getElementById("resultNote").textContent = labels[lang].resultNote;
        document.getElementById("statusTitle").textContent = labels[lang].statusTitle;
        document.getElementById("statusSub").textContent = labels[lang].statusSub;
        document.getElementById("safetyAlert").textContent = labels[lang].safetyAlert;
        document.getElementById("heroTitle").textContent = labels[lang].heroTitle;
        document.getElementById("privacyPill").textContent = labels[lang].privacyPill;
        document.getElementById("nextBtn").textContent = step === 4 ? labels[lang].submit : labels[lang].next;
        document.getElementById("backBtn").textContent = labels[lang].back;
        document.getElementById("safeNowYes").textContent = labels[lang].yes;
        document.getElementById("safeNowNo").textContent = labels[lang].no;
        document.getElementById("childrenYes").textContent = labels[lang].yes;
        document.getElementById("childrenNo").textContent = labels[lang].no;
        document.getElementById("petsYes").textContent = labels[lang].yes;
        document.getElementById("petsNo").textContent = labels[lang].no;
        document.getElementById("pregnantYes").textContent = labels[lang].yes;
        document.getElementById("pregnantNo").textContent = labels[lang].no;
        document.getElementById("actionFeedback").textContent = "";
        renderChips();
        updateCallouts();
      }

      function setSubmitting(isSubmitting) {
        document.getElementById("nextBtn").disabled = isSubmitting;
        document.getElementById("backBtn").disabled = isSubmitting;
        document.getElementById("langBtn").disabled = isSubmitting;
        if (isSubmitting) {
          document.getElementById("nextBtn").textContent = labels[lang].starting;
          document.getElementById("actionFeedback").textContent = labels[lang].startingSub;
        } else {
          document.getElementById("nextBtn").textContent = step === 4 ? labels[lang].submit : labels[lang].next;
        }
      }

      function setStep(n) {
        step = n;
        document.getElementById("step1").classList.toggle("hide", step !== 1);
        document.getElementById("step2").classList.toggle("hide", step !== 2);
        document.getElementById("step3").classList.toggle("hide", step !== 3);
        document.getElementById("step4").classList.toggle("hide", step !== 4);
        document.getElementById("backBtn").classList.toggle("hide", step === 1);
        document.querySelectorAll(".progress-dot").forEach((dot, i) => {
          dot.classList.toggle("filled", i + 1 <= step);
        });
        syncLabels();
      }

      document.getElementById("langBtn").onclick = () => {
        const order = ["en", "es"];
        lang = order[(order.indexOf(lang) + 1) % order.length];
        document.getElementById("langBtn").textContent = labels[lang].nextLangShort;
        syncLabels();
      };

      document.getElementById("minus").onclick = () => {
        state.people_count = Math.max(1, state.people_count - 1);
        document.getElementById("peopleCount").textContent = String(state.people_count);
      };
      document.getElementById("plus").onclick = () => {
        state.people_count = Math.min(5, state.people_count + 1);
        document.getElementById("peopleCount").textContent = state.people_count === 5 ? "5+" : String(state.people_count);
      };

      document.querySelectorAll(".yn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const field = btn.dataset.field;
          const val = btn.dataset.val;
          if (field === "safeNow") {
            state.currently_safe = val === "true";
            document.getElementById("safeNowYes").classList.toggle("active", state.currently_safe);
            document.getElementById("safeNowNo").classList.toggle("active", !state.currently_safe);
          }
          if (field === "children") {
            state.has_children = val === "true";
            document.getElementById("childrenYes").classList.toggle("active", state.has_children);
            document.getElementById("childrenNo").classList.toggle("active", !state.has_children);
          }
          if (field === "pets") {
            state.has_pets = val === "true";
            document.getElementById("petsYes").classList.toggle("active", state.has_pets);
            document.getElementById("petsNo").classList.toggle("active", !state.has_pets);
          }
          if (field === "pregnant") {
            state.pregnant = val;
            document.getElementById("pregnantYes").classList.toggle("active", val === "yes");
            document.getElementById("pregnantNo").classList.toggle("active", val === "no");
          }
          updateCallouts();
        });
      });

      document.getElementById("location").addEventListener("input", () => clearValidation());
      document.getElementById("location").addEventListener("focus", () => clearValidation());
      document.getElementById("genderIdentity").addEventListener("change", (e) => {
        state.gender_identity = e.target.value;
      });
      document.getElementById("ageRange").addEventListener("change", (e) => {
        state.age_range = e.target.value;
      });
      document.getElementById("sobriety").addEventListener("change", (e) => {
        state.sobriety = e.target.value;
        updateCallouts();
      });

      function clearValidation() {
        document.querySelectorAll(".invalid").forEach((el) => el.classList.remove("invalid"));
        const fb = document.getElementById("actionFeedback");
        fb.textContent = "";
        fb.classList.remove("validation-error");
      }
      function validateStep() {
        clearValidation();
        if (step === 1) {
          if (state.needs.length === 0) {
            document.querySelector(".step1-chips")?.classList.add("invalid");
            const fb = document.getElementById("actionFeedback");
            fb.textContent = labels[lang].requiredNeeds;
            fb.classList.add("validation-error");
            fb.setAttribute("aria-live", "polite");
            return false;
          }
        }
        if (step === 2) {
          if (state.people_count < 1) return false;
        }
        if (step === 3) {
          const loc = document.getElementById("location").value.trim();
          if (!loc) {
            const locGroup = document.getElementById("location").closest(".field-group");
            locGroup?.classList.add("invalid");
            document.getElementById("location").classList.add("invalid");
            document.getElementById("location").focus();
            const fb = document.getElementById("actionFeedback");
            fb.textContent = labels[lang].requiredLocation;
            fb.classList.add("validation-error");
            return false;
          }
        }
        return true;
      }
      document.getElementById("backBtn").onclick = () => {
        clearValidation();
        setStep(Math.max(1, step - 1));
      };
      document.getElementById("nextBtn").onclick = async () => {
        if (step < 4) {
          if (!validateStep()) return;
          return setStep(step + 1);
        }
        state.preferred_language = document.getElementById("preferredLanguage").value;
        state.urgency = document.getElementById("urgency").value;
        state.accessibility_needs = document.getElementById("accessibilityNeeds").value;
        state.alternate_contact = document.getElementById("alternateContact").value.trim();
        state.location = document.getElementById("location").value.trim();
        state.child_ages = document.getElementById("childAges").value.trim();
        const userNotes = document.getElementById("notes").value.trim();
        state.notes = [
          userNotes,
          `currently_safe=${state.currently_safe ? "yes" : "no"}`,
          `gender_identity=${state.gender_identity}`,
          `age_range=${state.age_range}`,
          `child_ages=${state.child_ages || "none"}`,
          `pregnant=${state.pregnant}`,
          `sobriety=${state.sobriety}`,
          `preferred_language=${state.preferred_language}`,
          `urgency=${state.urgency}`,
          `accessibility_needs=${state.accessibility_needs}`,
          `alternate_contact=${state.alternate_contact || "none"}`,
        ]
          .filter(Boolean)
          .join(" | ");

        if (!state.location || state.needs.length === 0) {
          alert("Please select needs and enter location.");
          return;
        }
        await submitIntake();
      };

      async function submitIntake() {
        setSubmitting(true);
        document.getElementById("statusView").classList.remove("hide");
        document.getElementById("statusTitle").textContent = labels[lang].startingTitle;
        document.getElementById("statusSub").textContent = labels[lang].startingSub;
        document.getElementById("log").innerHTML = `
          <div class="log-item">
            <div class="log-item-name">Eden received your request</div>
            <span class="log-item-tag">Starting</span>
          </div>
        `;
        document.getElementById("wizard").classList.add("hide");
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort("request_timeout"), 15000);
          const res = await fetch(`${API}/api/intake`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(state),
            signal: controller.signal,
          });
          clearTimeout(timeoutId);
          const text = await res.text();
          let data = {};
          try {
            data = text ? JSON.parse(text) : {};
          } catch {
            data = { error: text || "Failed to start intake." };
          }
          if (!res.ok) throw new Error(data.error || "Failed to start intake.");
          jobId = data.job_id;
          document.getElementById("statusTitle").textContent = labels[lang].statusTitle;
          document.getElementById("statusSub").textContent = labels[lang].statusSub;
          pollTimer = setInterval(loadStatus, 3000);
          loadStatus();
        } catch (error) {
          document.getElementById("statusView").classList.add("hide");
          document.getElementById("wizard").classList.remove("hide");
          document.getElementById("actionFeedback").textContent = labels[lang].startFailed;
          const message =
            error && typeof error === "object" && "name" in error && error.name === "AbortError"
              ? "Request timed out. Please confirm the API is running and try again."
              : error instanceof Error
                ? error.message
                : labels[lang].startFailed;
          alert(message);
        } finally {
          setSubmitting(false);
        }
      }

      async function loadStatus() {
        if (!jobId) return;
        const res = await fetch(`${API}/api/intake/status/${jobId}`);
        const data = await res.json();
        if (!res.ok) return;
        const log = document.getElementById("log");
        log.innerHTML = "";
        data.attempts.forEach((a) => {
          const row = document.createElement("div");
          const statusClass = a.status === "calling" ? "calling" : a.status === "failed" ? "failed" : a.status === "completed" ? "done" : "";
          row.className = `log-item ${statusClass}`;
          const tagClass = `log-item-tag ${statusClass}`;
          const tagText = a.status === "completed" ? "Completed" : a.status === "calling" ? "Calling…" : a.status;
          row.innerHTML = `
            <div class="log-item-name">${a.shelter_name}</div>
            <span class="${tagClass}">${tagText}</span>
            ${a.reason ? `<div class="log-item-reason">${a.reason}</div>` : ""}
          `;
          log.appendChild(row);
        });

        if (data.result) {
          clearInterval(pollTimer);
          const box = document.getElementById("result");
          box.className = "result-box success";
          box.classList.remove("hide");
          box.innerHTML = `
            <h3>Help Found</h3>
            <p><strong>${data.result.shelter_name}</strong><br>${data.result.address || ""} ${data.result.city || ""}<br>${data.result.intake_phone || ""}</p>
            <p>${labels[lang].found}</p>
          `;
        } else if (data.status === "failed") {
          clearInterval(pollTimer);
          const box = document.getElementById("result");
          box.className = "result-box warn";
          box.classList.remove("hide");
          box.innerHTML = `<h3>No Immediate Bed</h3><p>${labels[lang].noBeds(data.attempts.length)}</p>`;
        }
      }

      let escCount = 0, escTimer = null;
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('safetyModal');
          if (modal) { modal.remove(); return; }
          escCount++;
          clearTimeout(escTimer);
          escTimer = setTimeout(() => escCount = 0, 1000);
          if (escCount >= 2) window.location.replace('https://www.google.com');
        }
      });

      setStep(1);
      syncLabels();
      renderChips();
      document.getElementById("langBtn").textContent = labels[lang].nextLangShort;
    </script>
  </body>
</html>
